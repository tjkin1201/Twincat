@model TwinCatQA.Application.Services.ReportModel
@{
    var session = Model.Session;
    var score = session.OverallQualityScore;
    var grade = score >= 90 ? "A" : score >= 80 ? "B" : score >= 70 ? "C" : score >= 60 ? "D" : "F";
    var gradeColor = score >= 90 ? "#198754" : score >= 80 ? "#0dcaf0" : score >= 70 ? "#ffc107" : score >= 60 ? "#fd7e14" : "#dc3545";
}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TwinCAT ì½”ë“œ í’ˆì§ˆ ê²€ì¦ ë¦¬í¬íŠ¸ - @session.ProjectPath</title>

    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.0.0/dist/chart.umd.min.js"></script>

    <!-- ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .report-header { margin-bottom: 30px; border-bottom: 3px solid #007bff; padding-bottom: 20px; }
        .report-header h1 { color: #333; margin: 0 0 15px 0; }
        .report-meta { display: flex; flex-wrap: wrap; gap: 15px; font-size: 14px; }
        .report-meta-item { display: flex; align-items: center; gap: 5px; }
        .quality-score { padding: 10px 20px; border-radius: 5px; color: white; font-weight: bold; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { padding: 20px; border-radius: 8px; text-align: center; color: white; }
        .stat-card.critical { background-color: #dc3545; }
        .stat-card.high { background-color: #fd7e14; }
        .stat-card.medium { background-color: #ffc107; color: #333; }
        .stat-card.low { background-color: #0dcaf0; }
        .stat-card h3 { margin: 0 0 10px 0; font-size: 14px; opacity: 0.9; }
        .stat-value { font-size: 32px; font-weight: bold; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin: 30px 0; }
        .chart-container { padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .violations-section { margin: 30px 0; }
        .violation-card { margin: 15px 0; padding: 20px; border-radius: 8px; border-left: 4px solid #ccc; background: #f8f9fa; }
        .violation-card.severity-critical { border-left-color: #dc3545; }
        .violation-card.severity-high { border-left-color: #fd7e14; }
        .violation-card.severity-medium { border-left-color: #ffc107; }
        .violation-card.severity-low { border-left-color: #0dcaf0; }
        .violation-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .violation-title { font-weight: bold; color: #333; }
        .violation-badges { display: flex; gap: 5px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .badge.severity-critical { background-color: #dc3545; color: white; }
        .badge.severity-high { background-color: #fd7e14; color: white; }
        .badge.severity-medium { background-color: #ffc107; color: #333; }
        .badge.severity-low { background-color: #0dcaf0; color: white; }
        .badge.bg-secondary { background-color: #6c757d; color: white; }
        .violation-location { margin: 10px 0; color: #666; font-size: 14px; font-family: monospace; }
        .violation-suggestion { margin: 10px 0; padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; }
        .code-snippet { margin: 10px 0; padding: 15px; background: #2b2b2b; color: #f8f8f2; border-radius: 5px; overflow-x: auto; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; }
        .code-highlight { margin: 0; }
        .keyword { color: #66d9ef; font-weight: bold; }
        .comment { color: #75715e; font-style: italic; }
        .string { color: #e6db74; }
        .number { color: #ae81ff; }
        table { width: 100%; }
        th { background-color: #007bff; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #dee2e6; }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <header class="report-header">
            <h1>ğŸ“Š TwinCAT ì½”ë“œ í’ˆì§ˆ ê²€ì¦ ë¦¬í¬íŠ¸</h1>
            <div class="report-meta">
                <div class="report-meta-item">
                    <i>ğŸ“</i>
                    <span><strong>í”„ë¡œì íŠ¸:</strong> @System.IO.Path.GetFileName(session.ProjectPath)</span>
                </div>
                <div class="report-meta-item">
                    <i>ğŸ“…</i>
                    <span><strong>ê²€ì¦ ì‹œê°„:</strong> @session.StartTime.ToString("yyyy-MM-dd HH:mm:ss")</span>
                </div>
                <div class="report-meta-item">
                    <i>â±ï¸</i>
                    <span><strong>ì†Œìš” ì‹œê°„:</strong> @((session.EndTime.HasValue ? (session.EndTime.Value - session.StartTime).TotalSeconds : 0).ToString("F2"))ì´ˆ</span>
                </div>
                <div class="quality-score" style="background-color: @gradeColor;">
                    <span>í’ˆì§ˆ ì ìˆ˜:</span>
                    <span class="score-value">@score.ToString("F1")</span>
                    <span>(@grade ë“±ê¸‰)</span>
                </div>
            </div>
        </header>

        <!-- ëŒ€ì‹œë³´ë“œ -->
        <section class="dashboard">
            <h2>ğŸ“ˆ ëŒ€ì‹œë³´ë“œ</h2>

            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="stats-grid">
                <div class="stat-card critical">
                    <h3>Critical</h3>
                    <div class="stat-value">@Model.CriticalCount</div>
                </div>
                <div class="stat-card high">
                    <h3>High</h3>
                    <div class="stat-value">@Model.HighCount</div>
                </div>
                <div class="stat-card medium">
                    <h3>Medium</h3>
                    <div class="stat-value">@Model.MediumCount</div>
                </div>
                <div class="stat-card low">
                    <h3>Low</h3>
                    <div class="stat-value">@Model.LowCount</div>
                </div>
            </div>

            <!-- ì°¨íŠ¸ -->
            <div class="charts-grid">
                <div class="chart-container">
                    <canvas id="qualityTrendChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="constitutionComplianceChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="violationDistributionChart"></canvas>
                </div>
            </div>
        </section>

        <!-- ìœ„ë°˜ ì‚¬í•­ ìš”ì•½ -->
        @if (Model.TotalViolations > 0)
        {
            <section class="violations-section">
                <h2>ğŸš¨ ìœ„ë°˜ ì‚¬í•­ ìƒì„¸</h2>

                @foreach (var severityGroup in Model.ViolationsBySeverity)
                {
                    var severity = severityGroup.Key.ToString().ToLower();
                    var violations = severityGroup.Value;

                    <h3 class="mt-4 mb-3">@severityGroup.Key ìœ„ë°˜ (@(violations.Count)ê°œ)</h3>

                    @foreach (var violation in violations)
                    {
                        <div class="violation-card severity-@severity">
                            <div class="violation-header">
                                <div class="violation-title">@violation.Message</div>
                                <div class="violation-badges">
                                    <span class="badge severity-@severity">@severityGroup.Key</span>
                                    <span class="badge bg-secondary">@violation.RuleId</span>
                                </div>
                            </div>

                            <div class="violation-location">
                                ğŸ“„ @violation.FilePath:@violation.Line
                            </div>

                            @if (!string.IsNullOrEmpty(violation.Suggestion))
                            {
                                <div class="violation-suggestion">
                                    @violation.Suggestion
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(violation.CodeSnippet))
                            {
                                <div class="code-snippet">
                                    @Raw(GetHighlightedCode(violation.CodeSnippet))
                                </div>
                            }
                        </div>
                    }
                }
            </section>
        }
        else
        {
            <section class="violations-section text-center">
                <h2>âœ… ìœ„ë°˜ ì‚¬í•­ ì—†ìŒ</h2>
                <p class="text-muted mt-3">ì¶•í•˜í•©ë‹ˆë‹¤! ì½”ë“œê°€ ëª¨ë“  í’ˆì§ˆ ê·œì¹™ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤.</p>
            </section>
        }

        <!-- íŒŒì¼ë³„ ìš”ì•½ -->
        @if (Model.ViolationsByFile.Count > 0)
        {
            <section class="violations-section">
                <h2>ğŸ“‚ íŒŒì¼ë³„ ìœ„ë°˜ ìš”ì•½</h2>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>íŒŒì¼ ê²½ë¡œ</th>
                                <th class="text-center">ìœ„ë°˜ ê°œìˆ˜</th>
                                <th class="text-center">Critical</th>
                                <th class="text-center">High</th>
                                <th class="text-center">Medium</th>
                                <th class="text-center">Low</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var fileGroup in Model.ViolationsByFile.OrderByDescending(g => g.Value.Count))
                            {
                                var violations = fileGroup.Value;
                                <tr>
                                    <td><code>@fileGroup.Key</code></td>
                                    <td class="text-center"><strong>@violations.Count</strong></td>
                                    <td class="text-center">@violations.Count(v => v.Severity == TwinCatQA.Domain.Models.ViolationSeverity.Critical)</td>
                                    <td class="text-center">@violations.Count(v => v.Severity == TwinCatQA.Domain.Models.ViolationSeverity.High)</td>
                                    <td class="text-center">@violations.Count(v => v.Severity == TwinCatQA.Domain.Models.ViolationSeverity.Medium)</td>
                                    <td class="text-center">@violations.Count(v => v.Severity == TwinCatQA.Domain.Models.ViolationSeverity.Low)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </section>
        }

        <!-- í‘¸í„° -->
        <footer class="text-center mt-5 mb-3">
            <p class="text-muted">
                ë¦¬í¬íŠ¸ ìƒì„± ì‹œê°„: @Model.GeneratedAt.ToString("yyyy-MM-dd HH:mm:ss") |
                TwinCAT ì½”ë“œ í’ˆì§ˆ ê²€ì¦ ë„êµ¬ v1.0
            </p>
        </footer>
    </div>

    <!-- Chart.js ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // í’ˆì§ˆ ì¶”ì´ ì°¨íŠ¸
        const qualityTrendData = @Raw(Model.QualityTrendChartJson);
        const qualityTrendChart = new Chart(
            document.getElementById('qualityTrendChart'),
            qualityTrendData
        );

        // í—Œì¥ ì¤€ìˆ˜ìœ¨ ì°¨íŠ¸
        const constitutionComplianceData = @Raw(Model.ConstitutionComplianceChartJson);
        const constitutionComplianceChart = new Chart(
            document.getElementById('constitutionComplianceChart'),
            constitutionComplianceData
        );

        // ìœ„ë°˜ ë¶„í¬ ì°¨íŠ¸
        const violationDistributionData = @Raw(Model.ViolationDistributionChartJson);
        const violationDistributionChart = new Chart(
            document.getElementById('violationDistributionChart'),
            violationDistributionData
        );
    </script>
</body>
</html>

@functions {
    /// <summary>
    /// ì½”ë“œ ìŠ¤ë‹ˆí« í•˜ì´ë¼ì´íŒ…
    /// </summary>
    private string GetHighlightedCode(string code)
    {
        var highlighter = new TwinCatQA.Application.Services.CodeHighlighter();
        return highlighter.HighlightStructuredText(code);
    }
}
