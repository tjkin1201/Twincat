# TwinCAT 코드 비교 도구 고도화 요구사항 명세서

**작성일**: 2025-11-24
**버전**: 1.0
**우선순위**: 사용자 정의 (5→4→3→2→1)

---

## 📊 현재 상황

### ✅ 잘 작동하는 기능
- **Variable 변경**: 변수명, 타입, 초기값 변경을 명확하게 표시
- **Data Type 변경**: 구조체/열거형 필드 추가/삭제/수정 명확

### ⚠️ 개선 필요 영역
- **I/O Mapping**: 주소 변경만 감지, 이유 불명확
- **Logic 변경**: 파일 diff만 제공, 의미적 변화와 컨텍스트 부족

---

## 🎯 요구사항 상세

### 1순위: 전체 컨텍스트 비교 (Side-by-Side Diff Viewer)

#### 기능 설명
변경된 코드의 전체 컨텍스트를 좌우 분할 화면으로 비교하여, 변경 전후 전체 파일을 확인할 수 있는 기능

#### 상세 요구사항
- **표시 형태**: Git 스타일 Side-by-Side (좌우 분할)
- **표시 범위**: 전체 파일 표시 (변경 부분만이 아닌 파일 전체)
- **문법 하이라이팅**: Structured Text 키워드, 변수, 함수 등 색상 구분
- **변경 부분 강조**:
  - 추가된 라인: 녹색 배경
  - 삭제된 라인: 빨간색 배경
  - 수정된 라인: 노란색 배경
- **라인 번호**: 양쪽 코드의 라인 번호 표시 및 매칭
- **접기/펼치기**: 변경 없는 블록은 접어서 숨기기 가능
- **스크롤 동기화**: 좌우 스크롤이 동기화되어 함께 이동

#### UI 레이아웃
```
┌─────────────────────────────────────────────────────┐
│ Logic Changes - Side-by-Side Diff                   │
├──────────────────┬──────────────────────────────────┤
│ FB_MotorControl  │ Filter: [All/Changed Only]       │
│ (Before)         │ [Expand All] [Collapse All]      │
├──────────────────┼──────────────────────────────────┤
│     1 │ PROGRAM  │     1 │ PROGRAM                  │
│     2 │ VAR      │     2 │ VAR                      │
│ -   3 │   speed  │ +   3 │   speed : REAL          │ ← 변경
│     4 │ END_VAR  │     4 │   enabled : BOOL         │ ← 추가
│          ...     │     5 │ END_VAR                  │
└──────────────────┴──────────────────────────────────┘
```

#### 활용 시나리오
1. **코드 리뷰**: 변경 사항을 상세히 검토하여 승인/거부 결정
2. **HTML/PDF 리포트**: 변경 내역을 문서로 생성하여 배포
3. **변경 이력 추적**: 누가, 언제, 무엇을 바꿨는지 기록
4. **교육/학습**: 코드 변경 패턴을 학습하고 팀원과 공유

---

### 2순위: 영향도 분석 (Impact Analysis with Heatmap)

#### 기능 설명
변경된 코드가 다른 부분에 미치는 영향을 종합적으로 분석하고, 파일별 영향도를 히트맵으로 시각화

#### 상세 요구사항

**분석 범위**:
1. **직접 호출자**: 변경된 함수/FB를 직접 호출하는 모든 위치
2. **변수 참조**: 변경된 변수를 사용하는 모든 코드
3. **타입 의존성**: 변경된 데이터 타입을 사용하는 모든 변수/함수
4. **간접 영향**: A→B→C 호출 체인에서 C 변경 시 A도 영향 받음

**시각화**: 히트맵
- 프로젝트 트리에서 각 파일의 영향도를 색상으로 표시
- 🔴 빨강 (High): 직접적이고 중대한 영향
- 🟠 주황 (Medium): 간접적 영향
- 🟡 노랑 (Low): 미미한 영향
- ⚪ 회색 (None): 영향 없음

**추가 정보**:
1. **위험도 평가**:
   - ⛔ Critical: 타입 불일치, 컴파일 오류 가능성
   - ⚠️ Warning: 논리 오류 가능성, 테스트 필요
   - ℹ️ Info: 영향 있으나 안전
2. **파일 경로**: `FB_MotorControl.TcPOU:156` (파일명:라인번호)
3. **호출 빈도**: "10곳에서 사용", "5개 함수에 영향"
4. **테스트 권장**: "다음 항목 테스트 필요: ..."

#### UI 레이아웃
```
┌─────────────────────────────────────────────────────┐
│ Impact Analysis - Heatmap View                       │
├─────────────────────┬───────────────────────────────┤
│ Project Tree        │ Details                        │
│ 📁 PM1              │ ⛔ FB_MotorControl.Speed       │
│ ├─📄 MAIN.TcPOU 🔴 │    타입 변경: INT → REAL      │
│ ├─📄 FB_Conv... 🟠 │                                │
│ ├─📄 SEQ_Pro... 🟡 │ 📊 직접 영향: 3곳              │
│ └─📄 GVL_... ⚪    │ • MAIN.TcPOU:234 ⚠️          │
│                     │ • SEQ_Production:156 ⛔        │
│ [Export Report]     │ • FB_Conveyor:89 ℹ️           │
└─────────────────────┴───────────────────────────────┘
```

#### 활용 시나리오
1. **테스트 계획**: 영향 받는 모든 부분을 식별하여 테스트 범위 결정
2. **리스크 평가**: 변경의 위험도를 평가하여 승인 여부 결정
3. **리팩토링 가이드**: 변경 후 수정해야 할 다른 코드 식별
4. **문서화**: 영향도 분석 결과를 릴리스 노트에 포함

---

### 3순위: Logic 변경 이유 추론 (Change Reason Inference)

#### 기능 설명
코드 변경의 "왜"를 자동으로 추론하여 표시. 주석, 변수명, 로직 패턴을 분석하고, 선택적으로 AI를 활용

#### 상세 요구사항

**추론 소스**:
1. **코드 주석**:
   - 새로 추가되거나 변경된 주석 분석
   - `// TODO`, `// FIXME`, `// BUG` 등 키워드 감지
2. **변수명 패턴**:
   - `temp` → `criticalTemp`: 안전성 강화 의도
   - `counter` → `counterWithReset`: 기능 추가 의도
3. **로직 패턴 분석**:
   - IF 조건 추가: 조건 강화
   - CASE 분기 추가: 기능 확장
   - 타이머 값 변경: 타이밍 조정

**변경 카테고리** (4가지):
- 🆕 **기능 추가**: 새로운 로직이나 조건 추가
- 🐛 **버그 수정**: 오류 수정, 예외 처리 추가
- ⚡ **성능 최적화**: 알고리즘 개선, 불필요한 연산 제거
- 🔧 **리팩토링**: 코드 구조 개선, 가독성 향상

**신뢰도 표시** (아이콘):
- ✅ **확실**: 명확한 증거 (주석, 변수명)
- ⚠️ **추정**: 패턴 기반 추론
- ❓ **불확실**: 충분한 정보 없음

**AI 활용** (선택 가능):
- 사용자가 On/Off 토글 가능
- AI 사용 시: GPT/Claude 등을 활용한 상세 분석
- AI 미사용 시: 규칙 기반 패턴 매칭만 사용

#### UI 레이아웃
```
┌─────────────────────────────────────────────────────┐
│ Logic Changes - With Reason Inference                │
│ [AI Analysis: ON ✓ | OFF]                           │
├─────────────────────────────────────────────────────┤
│ ✅ FB_MotorControl.TcPOU:45-67                      │
│    🆕 기능 추가                                      │
│    "initialized 변수 추가로 초기화 상태 확인 로직"    │
│                                                      │
│ ⚠️ SEQ_Production.TcPOU:156                        │
│    🐛 버그 수정 (추정)                              │
│    "타이머 값 변경: 1000ms → 1500ms"                │
│    주석: "// 타이밍 이슈 수정"                       │
└─────────────────────────────────────────────────────┘
```

#### 추론 예시

**Case 1: 확실 (✅)**
```
변경 전: IF Temperature > 100 THEN
변경 후: IF Temperature > 120 THEN
주석 추가: "// 온도 임계값 상향 조정 (안전 마진 확대)"

추론 결과: ⚡ 성능 최적화 (확실 ✅)
설명: "온도 임계값을 20% 상향하여 불필요한 알람 감소"
```

**Case 2: 추정 (⚠️)**
```
변경 전: counter : INT
변경 후: counter : DINT

추론 결과: 🐛 버그 수정 (추정 ⚠️)
설명: "INT 오버플로 방지를 위해 DINT로 확장"
```

**Case 3: 불확실 (❓)**
```
변경: 여러 줄의 복잡한 수식 변경

추론 결과: ❓ 분류 불가 (불확실)
제안: "AI 분석 활성화 또는 주석 추가 권장"
```

---

### 4순위: Logic 변경 시각화

> **Note**: 1순위 (Side-by-Side Diff Viewer)에서 대부분 커버됨

추가 개선 사항:
- 제어 흐름 그래프 (Control Flow Graph) 옵션
- 변경 전후 상태 머신 다이어그램 비교

---

### 5순위: I/O Mapping 변경 이유 분석

> **Note**: 3순위 (Logic 변경 이유 추론)와 유사한 접근

#### 추가 고려사항
- 하드웨어 설정 파일 (.TcIO) 분석
- I/O 주소 재배치 패턴 감지
- 하드웨어 교체 여부 추론

---

## 🛠️ 기술적 구현 전략

### 1순위: Side-by-Side Diff Viewer
**필요 기술**:
- Diff 알고리즘: Myers diff algorithm 또는 Patience diff
- 문법 하이라이팅: ANTLR4 기반 ST 파서 활용
- UI 컴포넌트: AvalonEdit, ICSharpCode.TextEditor, 또는 Monaco Editor 통합

**구현 단계**:
1. Diff 엔진 구현 (DiffPlex 라이브러리 활용)
2. ST 문법 하이라이터 개발
3. WPF Side-by-Side 뷰 구현
4. 스크롤 동기화 및 접기/펼치기 기능

### 2순위: 영향도 분석
**필요 기술**:
- 정적 분석: 함수 호출 그래프 (Call Graph) 생성
- 변수 참조 추적: 데이터 흐름 분석 (Data Flow Analysis)
- 타입 의존성: 타입 시스템 분석

**구현 단계**:
1. AST 기반 정적 분석 엔진 구축
2. 호출 그래프 및 의존성 그래프 생성
3. 영향도 계산 알고리즘 구현
4. 히트맵 시각화 UI 개발

### 3순위: 변경 이유 추론
**필요 기술**:
- 자연어 처리: 주석 및 변수명 분석
- 패턴 매칭: 정규식 및 AST 패턴
- AI 통합: OpenAI API, Azure OpenAI, 또는 로컬 LLM

**구현 단계**:
1. 주석 및 변수명 분석 모듈
2. 로직 패턴 분석 엔진
3. 규칙 기반 추론 시스템
4. (옵션) AI 통합 레이어

---

## 📅 구현 로드맵

### Phase 1: 기반 구축 (2-3주)
- [ ] ANTLR4 파서 완성 (1순위, 2순위, 3순위 모두 필요)
- [ ] AST 기반 정적 분석 인프라
- [ ] 테스트 프레임워크 구축

### Phase 2: 1순위 구현 (3-4주)
- [ ] Diff 알고리즘 통합
- [ ] Side-by-Side 뷰 UI 개발
- [ ] 문법 하이라이팅 구현
- [ ] 접기/펼치기 및 스크롤 동기화

### Phase 3: 2순위 구현 (4-5주)
- [ ] 호출 그래프 생성
- [ ] 영향도 분석 알고리즘
- [ ] 히트맵 시각화
- [ ] 위험도 평가 엔진

### Phase 4: 3순위 구현 (2-3주)
- [ ] 주석/변수명 분석 모듈
- [ ] 패턴 매칭 엔진
- [ ] 규칙 기반 추론 시스템
- [ ] (옵션) AI 통합

### Phase 5: 통합 및 최적화 (2주)
- [ ] 모든 기능 통합
- [ ] 성능 최적화
- [ ] 사용자 테스트 및 피드백
- [ ] 문서화 완성

**총 예상 기간**: 13-17주 (약 3-4개월)

---

## 🎯 성공 기준

### 1순위
- [ ] 전체 파일을 Side-by-Side로 비교 가능
- [ ] 변경 부분이 명확하게 하이라이트됨
- [ ] 접기/펼치기로 변경 없는 부분 숨기기 가능
- [ ] HTML/PDF 리포트 생성 가능

### 2순위
- [ ] 직접/간접 영향도 모두 분석
- [ ] 히트맵으로 파일별 영향도 시각화
- [ ] 위험도 평가 (Critical/Warning/Info) 제공
- [ ] 영향 받는 코드 위치 (파일:라인) 정확히 표시

### 3순위
- [ ] 4가지 카테고리로 변경 이유 분류
- [ ] 신뢰도 (✅⚠️❓) 표시
- [ ] 규칙 기반 추론 정확도 70% 이상
- [ ] AI 활성화 시 정확도 85% 이상

---

## 📊 우선순위 재확인

**사용자 지정 우선순위**:
1. **1순위**: 전체 컨텍스트 비교 → 즉시 사용 가능한 가치
2. **2순위**: 영향도 분석 → 리스크 관리에 필수
3. **3순위**: 변경 이유 추론 → 코드 리뷰 효율화
4. **4순위**: Logic 시각화 → 1순위에 포함
5. **5순위**: I/O Mapping 분석 → 3순위 기술 재사용

---

## 🔗 관련 문서
- [TwinCAT QA Tool README](../README.md)
- [QUICKSTART Guide](../QUICKSTART.md)
- [Code Analysis Report](../docs/TwinCatQA_Code_Analysis_Report.md)
- [Troubleshooting Report](../docs/TwinCatQA_Troubleshooting_Resolution_Report.md)

---

**문서 버전**: 1.0
**최종 업데이트**: 2025-11-24
**작성자**: 요구사항 탐색 프로세스 (/sc:brainstorm)
