# TwinCAT Code QA Tool - 분석 규칙 및 검출 케이스 가이드

## 개요

이 문서는 TwinCAT Code QA Tool이 검출할 수 있는 코드 문제와 평가 기준을 정리합니다.

---

## 1. 변수 사용 분석 (Variable Usage Analyzer)

### 검출 케이스

| 케이스 | 심각도 | 설명 | 예시 |
|--------|--------|------|------|
| **미사용 변수** | Warning | 선언되었지만 읽기/쓰기가 없는 변수 | `VAR unusedVar : INT; END_VAR` (사용 안함) |
| **미선언 변수** | Error | 선언 없이 사용된 변수 | `x := undeclaredVar + 1;` |
| **변수 섀도잉** | Warning | 상위 스코프 변수를 가리는 동일 이름 변수 | 로컬 `count`가 글로벌 `count`를 가림 |
| **쓰기 전 읽기** | Warning | 초기화 없이 값을 읽는 변수 | `y := x;` (x 초기화 안됨) |
| **쓰기만 하는 변수** | Info | 값을 쓰기만 하고 읽지 않는 변수 | `result := 10;` (이후 사용 안함) |

### 평가 기준

```
미사용 변수가 있으면:
- 코드 정리 필요 (불필요한 메모리 사용)
- 개발자가 구현을 잊었을 가능성

미선언 변수가 있으면:
- 컴파일 오류 발생
- 오타 또는 복사-붙여넣기 실수

섀도잉이 있으면:
- 의도치 않은 버그 가능성
- 디버깅 어려움
```

---

## 2. 의존성 분석 (Dependency Analyzer)

### 검출 케이스

| 케이스 | 심각도 | 설명 | 예시 |
|--------|--------|------|------|
| **순환 의존성** | Critical | A→B→C→A 형태의 순환 참조 | FB_Motor → FB_Sensor → FB_Motor |
| **누락된 의존성** | Error | 참조하는 FB/Function이 존재하지 않음 | `fbControl : FB_NotExist;` |
| **과도한 의존성** | Warning | 하나의 POU가 너무 많은 의존성 보유 | 10개 이상 FB 참조 |
| **깊은 의존성 체인** | Info | 의존성 깊이가 너무 깊음 | A→B→C→D→E→F (깊이 6) |

### 평가 기준

```
순환 의존성이 있으면:
- 초기화 순서 문제 발생
- 유지보수 어려움
- 리팩토링 필요

과도한 의존성이 있으면:
- 단일 책임 원칙 위반 가능성
- 모듈 분리 고려 필요
```

---

## 3. I/O 매핑 검증 (I/O Mapping Validator)

### 검출 케이스

| 케이스 | 심각도 | 설명 | 예시 |
|--------|--------|------|------|
| **타입 불일치** | Critical | I/O 변수와 매핑 타입 불일치 | BOOL 변수에 WORD 주소 매핑 |
| **주소 충돌** | Critical | 동일 주소에 여러 변수 매핑 | `%IX0.0`에 2개 변수 |
| **미매핑 I/O** | Warning | 선언되었지만 매핑 없는 I/O 변수 | `sensor AT %I* : BOOL;` |
| **잘못된 주소 형식** | Error | 유효하지 않은 I/O 주소 | `%IZ0.0` (Z는 없음) |
| **범위 초과 주소** | Error | 하드웨어 범위 초과 주소 | `%IX999.999` |

### 평가 기준

```
타입 불일치가 있으면:
- 런타임 오류 또는 예상치 못한 동작
- 하드웨어 손상 가능성

주소 충돌이 있으면:
- 데이터 덮어쓰기 발생
- 디버깅 매우 어려움
```

---

## 4. 컴파일 검증 (Compilation Service)

### 검출 케이스

| 케이스 | 심각도 | 설명 | 예시 |
|--------|--------|------|------|
| **구문 오류** | Critical | ST 언어 문법 오류 | `IF x = 1 THEN` (THEN 누락) |
| **타입 오류** | Error | 호환되지 않는 타입 연산 | `boolVar := intVar;` |
| **중복 선언** | Error | 동일 스코프에서 같은 이름 | `VAR x, x : INT;` |
| **함수 시그니처 불일치** | Error | 인자 개수/타입 불일치 | `Add(1)` (2개 필요) |

---

## 5. 품질 점수 계산

### 점수 산출 공식

```
품질 점수 = 100 - Σ(심각도 가중치 × 이슈 개수)

심각도 가중치:
- Critical: 10점 감점
- Error: 5점 감점
- Warning: 2점 감점
- Info: 0.5점 감점

최소 점수: 0점
```

### 품질 등급

| 등급 | 점수 범위 | 의미 |
|------|-----------|------|
| A | 90-100 | 우수 - 프로덕션 배포 가능 |
| B | 80-89 | 양호 - 경미한 개선 필요 |
| C | 70-79 | 보통 - 개선 권장 |
| D | 60-69 | 미흡 - 개선 필수 |
| F | 0-59 | 불합격 - 배포 불가 |

### CI/CD 품질 게이트 예시

```bash
# 80점 미만이면 빌드 실패
twincat-qa quality ./Project --threshold 80

# 종료 코드
# 0 = 통과 (점수 >= 임계값)
# 1 = 실패 (점수 < 임계값)
```

---

## 6. 실제 검출 예시

### 예시 1: 변수 문제

```iecst
PROGRAM MAIN
VAR
    motorSpeed : REAL;      // 미사용 (Warning)
    sensorValue : INT;
    tempVar : BOOL;         // 쓰기만 함 (Info)
END_VAR

result := undefinedVar;     // 미선언 (Error)
tempVar := TRUE;
```

**검출 결과:**
- Warning: `motorSpeed` 미사용 변수
- Info: `tempVar` 쓰기 전용 변수
- Error: `undefinedVar` 미선언 변수

### 예시 2: 의존성 문제

```iecst
FUNCTION_BLOCK FB_Controller
VAR
    fbMotor : FB_Motor;
    fbSensor : FB_Sensor;
    fbPump : FB_Pump;
    // ... 12개 FB 인스턴스
END_VAR
```

**검출 결과:**
- Warning: 과도한 의존성 (12개 > 권장 10개)

### 예시 3: I/O 매핑 문제

```iecst
VAR_GLOBAL
    startButton AT %IX0.0 : BOOL;
    emergencyStop AT %IX0.0 : BOOL;  // 충돌!
    motorOutput AT %QX0.0 : INT;     // 타입 불일치!
END_VAR
```

**검출 결과:**
- Critical: `%IX0.0` 주소 충돌
- Critical: `motorOutput` BOOL 주소에 INT 타입

---

## 7. 개발자 실수 예방 체크리스트

| # | 확인 항목 | 자동 검출 |
|---|-----------|-----------|
| 1 | 모든 선언 변수가 사용되는가? | ✅ |
| 2 | 모든 사용 변수가 선언되었는가? | ✅ |
| 3 | 변수 초기화 후 사용하는가? | ✅ |
| 4 | I/O 주소가 중복되지 않는가? | ✅ |
| 5 | I/O 타입이 일치하는가? | ✅ |
| 6 | 순환 참조가 없는가? | ✅ |
| 7 | FB 의존성이 적절한가? | ✅ |
| 8 | 문법 오류가 없는가? | ✅ |

---

---

## 8. 심화 분석 기능 (신규 추가)

### 8.1 순환 복잡도 분석

| 등급 | 복잡도 범위 | 의미 | 권장 조치 |
|------|-------------|------|-----------|
| A | 1-5 | 단순 | 유지 |
| B | 6-10 | 보통 | 양호 |
| C | 11-20 | 복잡 | 리팩토링 고려 |
| D | 21-30 | 매우 복잡 | 리팩토링 필수 |
| F | 31+ | 위험 | 즉시 분할 필요 |

**계산 공식:**
```
복잡도 = 1 + IF개수 + ELSIF개수 + CASE분기 + FOR + WHILE + REPEAT + AND + OR
```

### 8.2 메모리 영역 분석

| 검출 케이스 | 심각도 | 설명 |
|-------------|--------|------|
| **주소 중복** | Critical | 동일 I/O 주소에 여러 변수 매핑 |
| **부분 중첩** | Critical | 워드/더블워드 영역이 서로 겹침 |
| **비트/바이트 혼용** | Error | 같은 바이트에 비트와 바이트 접근 |
| **메모리 단편화** | Warning | 연속 영역에 10바이트 이상 갭 |

**예시:**
```iecst
VAR_GLOBAL
    startBtn AT %IX0.0 : BOOL;
    stopBtn AT %IX0.0 : BOOL;   // Critical: 주소 중복!
    wordData AT %IW0 : WORD;    // Error: %IX0.0과 영역 겹침!
END_VAR
```

**메모리 사용 통계:**
- 영역별 할당 변수 수
- 사용된 바이트/비트 수
- 단편화율 (%)
- 미사용 갭 목록

### 8.3 데드 코드 검출

| 검출 타입 | 심각도 | 예시 |
|-----------|--------|------|
| **항상 참 조건** | Warning | `IF TRUE THEN` |
| **항상 거짓 조건** | Error | `IF FALSE THEN` (실행 안됨) |
| **도달 불가 코드** | Error | RETURN 후 코드 |
| **주석 처리된 코드** | Info | `// IF oldCode THEN` |
| **ELSE 없는 CASE** | Warning | 예상치 못한 값 처리 불가 |

### 8.4 배열 경계 검사

| 검출 타입 | 심각도 | 설명 |
|-----------|--------|------|
| **상수 인덱스 초과** | Critical | `arr[15]` (범위 0..10) |
| **음수 인덱스** | Critical | `arr[-1]` |
| **FOR 루프 범위 초과** | Critical | `FOR i := 0 TO 15 DO arr[i]` |
| **동적 인덱스 미검증** | Warning | 범위 체크 없이 변수 인덱스 사용 |

**안전한 패턴:**
```iecst
// 경계 검사 후 접근
IF index >= 0 AND index <= 10 THEN
    arr[index] := value;
END_IF

// LIMIT 함수 사용
safeIndex := LIMIT(0, index, 10);
arr[safeIndex] := value;
```

### 8.5 매직 넘버 검출

| 심각도 | 조건 | 예시 |
|--------|------|------|
| **Error** | 1000 초과 또는 0.001 미만 | `speed := 999999;` |
| **Warning** | 일반 하드코딩 숫자 | `delay := 500;` |
| **Info** | 이미 상수 정의된 값 | 중복 사용 |

**허용되는 숫자:**
- 0, 1, -1, 2, 10, 100, 1000
- 0.0, 1.0, 0.5, 2.0

**권장 패턴:**
```iecst
// 나쁜 예
timeout := 5000;

// 좋은 예
VAR CONSTANT
    TIMEOUT_MS : INT := 5000;
END_VAR
timeout := TIMEOUT_MS;
```

---

## 9. 심화 분석 품질 점수 영향

| 분석 항목 | 감점 기준 |
|-----------|-----------|
| 복잡도 D등급 | -3점/POU |
| 복잡도 F등급 | -5점/POU |
| 메모리 중복/중첩 | -10점/건 |
| 데드 코드 (Error) | -5점/건 |
| 배열 경계 초과 | -10점/건 |
| 매직 넘버 (Error) | -3점/건 |

---

## 10. 개발자 실수 예방 체크리스트 (심화)

| # | 확인 항목 | 자동 검출 |
|---|-----------|-----------|
| 1 | 복잡도가 20 이하인가? | ✅ |
| 2 | I/O 주소가 중복되지 않는가? | ✅ |
| 3 | 비트/바이트 영역이 혼용되지 않는가? | ✅ |
| 4 | 메모리 단편화가 적은가? | ✅ |
| 5 | 도달 불가능한 코드가 없는가? | ✅ |
| 6 | CASE 문에 ELSE가 있는가? | ✅ |
| 7 | 배열 인덱스가 범위 내인가? | ✅ |
| 8 | FOR 루프 범위가 배열과 일치하는가? | ✅ |
| 9 | 하드코딩 숫자가 상수화 되었는가? | ✅ |
| 10 | 주석 처리된 코드가 정리되었는가? | ✅ |

---

**문서 버전**: 2.0
**최종 수정**: 2025-11-21
**변경 사항**: 심화 분석 기능 5종 추가
